const express = require('express');
const cors = require('cors');
const rateLimit = require('express-rate-limit');
const helmet = require('helmet');
const cookieParser = require('cookie-parser');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const path = require('path');
const Database = require('./database');

const app = express();
const PORT = process.env.PORT || 10000;
const JWT_SECRET = process.env.JWT_SECRET || 'semana-inovacao-2025-secret-key';

// Inicializar banco de dados
const db = new Database();

// Trust proxy para Render
app.set('trust proxy', 1);

// Middlewares de seguran√ßa
app.use(helmet({
    contentSecurityPolicy: false,
    crossOriginEmbedderPolicy: false
}));

app.use(cookieParser());

// CORS configurado
app.use(cors({
    origin: true,
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'Cookie']
}));

// Rate limiting
const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutos
    max: 100, // 100 requests por IP
    message: { erro: 'Muitas tentativas. Tente novamente em 15 minutos.' },
    standardHeaders: true,
    legacyHeaders: false
});

const loginLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutos
    max: 5, // 5 tentativas de login por IP
    message: { erro: 'Muitas tentativas de login. Tente novamente em 15 minutos.' },
    standardHeaders: true,
    legacyHeaders: false
});

app.use(limiter);
app.use('/api/login', loginLimiter);

// Parse JSON
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Middleware de autentica√ß√£o
function verificarAuth(req, res, next) {
    const token = req.cookies.authToken;
    
    if (!token) {
        return res.status(401).json({ 
            sucesso: false, 
            mensagem: 'Acesso negado. Login necess√°rio.' 
        });
    }
    
    try {
        const decoded = jwt.verify(token, JWT_SECRET);
        req.user = decoded;
        console.log(`‚úÖ Acesso autorizado: ${decoded.email} de ${req.ip}`);
        next();
    } catch (error) {
        console.log(`‚ùå Token inv√°lido de ${req.ip}`);
        res.status(401).json({ 
            sucesso: false, 
            mensagem: 'Token inv√°lido' 
        });
    }
}

// Servir arquivos est√°ticos
app.use(express.static(path.join(__dirname, 'public')));

// ROTAS P√öBLICAS

// Status da API
app.get('/api/status', (req, res) => {
    res.json({
        status: 'Sistema Online',
        timestamp: new Date().toISOString(),
        environment: process.env.NODE_ENV || 'development',
        version: '2.0.2',
        frontend: 'Configurado',
        database: 'SQLite',
        port: PORT.toString()
    });
});

// Rota de inscri√ß√£o (P√öBLICA)
app.post('/api/inscricoes', async (req, res) => {
    try {
        const clientIP = req.ip || req.connection.remoteAddress;
        console.log(`üìù Nova inscri√ß√£o de ${clientIP}:`, { 
            nome: req.body.nome_completo, 
            email: req.body.email 
        });

        // Validar dados obrigat√≥rios
        const { nome_completo, email, cpf } = req.body;
        
        if (!nome_completo || !email || !cpf) {
            return res.status(400).json({
                sucesso: false,
                mensagem: 'Nome completo, email e CPF s√£o obrigat√≥rios'
            });
        }

        // Verificar se email j√° existe
        const emailExiste = await db.verificarEmailExiste(email);
        if (emailExiste) {
            console.log(`‚ùå Erro ao salvar inscri√ß√£o: Este email j√° est√° cadastrado`);
            return res.status(400).json({
                sucesso: false,
                mensagem: 'Este email j√° est√° cadastrado'
            });
        }

        // Verificar se CPF j√° existe
        const cpfExiste = await db.verificarCPFExiste(cpf);
        if (cpfExiste) {
            console.log(`‚ùå Erro ao salvar inscri√ß√£o: Este CPF j√° est√° cadastrado`);
            return res.status(400).json({
                sucesso: false,
                mensagem: 'Este CPF j√° est√° cadastrado'
            });
        }

        // Preparar dados para inser√ß√£o
        const dadosInscricao = {
            ...req.body,
            criado_em: new Date().toISOString(),
            atualizado_em: new Date().toISOString()
        };

        console.log('üìù Inserindo dados:', {
            nome: dadosInscricao.nome_completo,
            email: dadosInscricao.email,
            campos_total: Object.keys(dadosInscricao).length
        });

        // Salvar no banco
        const id = await db.criarInscricao(dadosInscricao);
        
        console.log(`‚úÖ Inscri√ß√£o salva com ID: ${id}`);
        console.log(`‚úÖ Inscri√ß√£o salva - ID: ${id}`);

        res.status(201).json({
            sucesso: true,
            mensagem: 'Inscri√ß√£o realizada com sucesso!',
            id: id
        });

    } catch (error) {
        console.error('‚ùå Erro ao processar inscri√ß√£o:', error);
        res.status(500).json({
            sucesso: false,
            mensagem: 'Erro interno do servidor'
        });
    }
});

// Login (P√öBLICO)
app.post('/api/login', async (req, res) => {
    try {
        const { email, senha } = req.body;
        const clientIP = req.ip || req.connection.remoteAddress;
        
        console.log(`üîê Tentativa de login: ${email} de ${clientIP}`);
        console.log(`üîê Tentativa de login: ${email} de ${clientIP}`);

        if (!email || !senha) {
            return res.status(400).json({
                sucesso: false,
                mensagem: 'Email e senha s√£o obrigat√≥rios'
            });
        }

        // Buscar usu√°rio
        const usuario = await db.buscarUsuarioPorEmail(email);
        
        if (!usuario) {
            console.log(`‚ùå Email n√£o encontrado: ${email}`);
            console.log(`‚ùå Login falhado: ${email} - Credenciais inv√°lidas`);
            return res.status(401).json({
                sucesso: false,
                mensagem: 'Credenciais inv√°lidas'
            });
        }

        // Verificar senha
        const senhaValida = await bcrypt.compare(senha, usuario.senha);
        
        if (!senhaValida) {
            console.log(`‚ùå Senha incorreta para: ${email}`);
            console.log(`‚ùå Login falhado: ${email} - Credenciais inv√°lidas`);
            return res.status(401).json({
                sucesso: false,
                mensagem: 'Credenciais inv√°lidas'
            });
        }

        // Gerar token JWT
        const token = jwt.sign(
            { 
                id: usuario.id, 
                email: usuario.email,
                nome: usuario.nome_completo
            },
            JWT_SECRET,
            { expiresIn: '24h' }
        );

        // Definir cookie httpOnly
        res.cookie('authToken', token, {
            httpOnly: true,
            secure: process.env.NODE_ENV === 'production',
            sameSite: 'lax',
            maxAge: 24 * 60 * 60 * 1000 // 24 horas
        });

        console.log(`‚úÖ Login bem-sucedido: ${email} de ${clientIP}`);
        console.log(`‚úÖ Login bem-sucedido: ${email}`);

        res.json({
            sucesso: true,
            mensagem: 'Login realizado com sucesso',
            usuario: {
                id: usuario.id,
                email: usuario.email,
                nome: usuario.nome_completo
            }
        });

    } catch (error) {
        console.error('‚ùå Erro no login:', error);
        res.status(500).json({
            sucesso: false,
            mensagem: 'Erro interno do servidor'
        });
    }
});

// APLICAR PROTE√á√ÉO DE AUTENTICA√á√ÉO NAS ROTAS SENS√çVEIS
app.use('/api/inscricoes', verificarAuth);
app.use('/api/estatisticas', verificarAuth);
app.use('/api/exportar', verificarAuth);
app.use('/api/verificar-token', verificarAuth);

// ROTAS PROTEGIDAS (SOMENTE ADMIN)

// Verificar token
app.get('/api/verificar-token', (req, res) => {
    // Se chegou aqui, o token √© v√°lido (verificado no middleware)
    res.json({
        sucesso: true,
        usuario: {
            id: req.user.id,
            email: req.user.email,
            nome: req.user.nome
        }
    });
});

// Listar inscri√ß√µes (PROTEGIDA)
app.get('/api/inscricoes', async (req, res) => {
    try {
        const page = parseInt(req.query.page) || 1;
        const limit = parseInt(req.query.limit) || 50;
        const search = req.query.search || '';

        const resultado = await db.listarInscricoes(page, limit, search);
        
        // REMOVER SENHAS das respostas por seguran√ßa
        const inscricoesSemSenha = resultado.inscricoes.map(ins => {
            const { senha, ...dadosSeguros } = ins;
            return dadosSeguros;
        });

        res.json({
            sucesso: true,
            dados: inscricoesSemSenha, // Dados sem senhas
            paginacao: resultado.paginacao
        });

    } catch (error) {
        console.error('‚ùå Erro ao listar inscri√ß√µes:', error);
        res.status(500).json({
            sucesso: false,
            mensagem: 'Erro ao carregar inscri√ß√µes'
        });
    }
});

// Estat√≠sticas (PROTEGIDA)
app.get('/api/estatisticas', async (req, res) => {
    try {
        const stats = await db.obterEstatisticas();
        
        res.json({
            sucesso: true,
            dados: stats
        });

    } catch (error) {
        console.error('‚ùå Erro ao obter estat√≠sticas:', error);
        res.status(500).json({
            sucesso: false,
            mensagem: 'Erro ao carregar estat√≠sticas'
        });
    }
});

// Exportar dados (PROTEGIDA)
app.get('/api/exportar', async (req, res) => {
    try {
        const formato = req.query.formato || 'csv';
        
        if (formato === 'csv') {
            const inscricoes = await db.listarTodasInscricoes();
            
            // REMOVER SENHAS do export por seguran√ßa
            const inscricoesSemSenha = inscricoes.map(ins => {
                const { senha, ...dadosSeguros } = ins;
                return dadosSeguros;
            });
            
            // Gerar CSV
            const headers = Object.keys(inscricoesSemSenha[0] || {});
            const csvContent = [
                headers.join(','),
                ...inscricoesSemSenha.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        // Escapar v√≠rgulas e aspas
                        return typeof value === 'string' && (value.includes(',') || value.includes('"')) 
                            ? `"${value.replace(/"/g, '""')}"` 
                            : value;
                    }).join(',')
                )
            ].join('\n');

            res.setHeader('Content-Type', 'text/csv; charset=utf-8');
            res.setHeader('Content-Disposition', `attachment; filename=inscricoes-${new Date().toISOString().split('T')[0]}.csv`);
            res.send('\ufeff' + csvContent); // BOM para UTF-8
        } else {
            res.status(400).json({
                sucesso: false,
                mensagem: 'Formato n√£o suportado'
            });
        }

    } catch (error) {
        console.error('‚ùå Erro ao exportar:', error);
        res.status(500).json({
            sucesso: false,
            mensagem: 'Erro ao exportar dados'
        });
    }
});

// Logout
app.post('/api/logout', (req, res) => {
    res.clearCookie('authToken');
    res.json({
        sucesso: true,
        mensagem: 'Logout realizado com sucesso'
    });
});

// Rota do admin
app.get('/admin', (req, res) => {
    const adminPath = path.join(__dirname, 'public', 'admin.html');
    console.log('üìÑ Tentando acessar admin path:', adminPath);
    res.sendFile(adminPath);
});

app.get('/admin/', (req, res) => {
    const adminPath = path.join(__dirname, 'public', 'admin.html');
    console.log('üìÑ Tentando acessar admin path:', adminPath);
    res.sendFile(adminPath);
});

// Rota principal
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// Middleware de erro 404
app.use('*', (req, res) => {
    res.status(404).json({
        sucesso: false,
        mensagem: 'Rota n√£o encontrada'
    });
});

// Middleware de tratamento de erros
app.use((error, req, res, next) => {
    console.error('‚ùå Erro n√£o tratado:', error);
    res.status(500).json({
        sucesso: false,
        mensagem: 'Erro interno do servidor'
    });
});

// Inicializar servidor
app.listen(PORT, '0.0.0.0', () => {
    console.log(`üöÄ Servidor rodando na porta ${PORT}`);
    console.log(`üåç URL: http://localhost:${PORT}`);
    console.log(`üîí Autentica√ß√£o: JWT com cookies httpOnly`);
    console.log(`üìä Database: SQLite inicializado`);
    console.log(`üõ°Ô∏è Seguran√ßa: Rotas protegidas ativadas`);
});

module.exports = app;